name: Sync Fork, Build and Release

on:
  schedule:
    - cron: '0 2 * * *'  # 每天UTC 2:00运行
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [master, subspace]

    outputs:
      master-version: ${{ steps.check-version.outputs.version }}
      master-changed: ${{ steps.check-version.outputs.changed }}
      subspace-version: ${{ steps.check-version.outputs.version }}
      subspace-changed: ${{ steps.check-version.outputs.changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version before sync
        id: version-before
        run: |
          VERSION=$(grep "^mod_version=" gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Sync fork from upstream
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/Dragonators/GTLAdditions.git || true
          git fetch upstream
          git merge upstream/${{ matrix.branch }} --no-edit || echo "No changes to merge or merge conflict"
          git push origin ${{ matrix.branch }} || echo "Nothing to push"

      - name: Fix build configuration
        run: |
          # Fix jade dependency format for Modrinth Maven
          sed -i 's|maven.modrinth:jade-1.20.1-forge-|maven.modrinth:jade:|g' build.gradle
          sed -i 's|jade:\$project.jade_version"|jade:$project.jade_version+forge"|g' build.gradle
          # Rename Jade jar to lowercase if exists
          if [ -f "libs/Jade-1.20.1-forge-11.9.2.jar" ]; then
            mv "libs/Jade-1.20.1-forge-11.9.2.jar" "libs/jade-1.20.1-forge-11.9.2.jar"
          fi
          # Add Modrinth Maven repository if not exists
          if ! grep -q "api.modrinth.com/maven" build.gradle; then
            sed -i '/cursemaven.com/,/}/a\    maven {\n        // Modrinth\n        url "https://api.modrinth.com/maven"\n        content {\n            includeGroup "maven.modrinth"\n        }\n    }' build.gradle
          fi

      - name: Get version after sync
        id: version-after
        run: |
          VERSION=$(grep "^mod_version=" gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check version change
        id: check-version
        run: |
          BEFORE="${{ steps.version-before.outputs.version }}"
          AFTER="${{ steps.version-after.outputs.version }}"
          echo "version=$AFTER" >> $GITHUB_OUTPUT
          if [ "$BEFORE" != "$AFTER" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed from $BEFORE to $AFTER"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $AFTER"
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '8.8'

      - name: Build
        run: gradle build --no-daemon

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gtladditions-${{ matrix.branch }}
          path: |
            build/libs/*.jar
            !build/libs/*-sources.jar
          if-no-files-found: error

      - name: Save version info
        run: |
          mkdir -p /tmp/version-info
          echo "${{ steps.check-version.outputs.version }}" > /tmp/version-info/${{ matrix.branch }}-version.txt
          echo "${{ steps.check-version.outputs.changed }}" > /tmp/version-info/${{ matrix.branch }}-changed.txt

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-info-${{ matrix.branch }}
          path: /tmp/version-info/

  release:
    needs: sync-and-build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Check existing releases
        id: check-releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if master release exists
          if gh release view "v$(cat version-info-master/master-version.txt)_master" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "master_release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "master_release_exists=false" >> $GITHUB_OUTPUT
          fi
          # Check if subspace release exists
          if gh release view "v$(cat version-info-subspace/subspace-version.txt)_subspace" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "subspace_release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "subspace_release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for version changes
        id: prepare-release
        run: |
          MASTER_VERSION=""
          SUBSPACE_VERSION=""

          if [ -f "version-info-master/master-version.txt" ]; then
            MASTER_VERSION=$(cat "version-info-master/master-version.txt")
          fi
          if [ -f "version-info-subspace/subspace-version.txt" ]; then
            SUBSPACE_VERSION=$(cat "version-info-subspace/subspace-version.txt")
          fi

          echo "master_version=$MASTER_VERSION" >> $GITHUB_OUTPUT
          echo "subspace_version=$SUBSPACE_VERSION" >> $GITHUB_OUTPUT

      - name: Create master Release
        if: steps.check-releases.outputs.master_release_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.prepare-release.outputs.master_version }}_master
          name: gtladditions-master v${{ steps.prepare-release.outputs.master_version }}
          body: Auto-release triggered by version update.
          files: gtladditions-master/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create subspace Release
        if: steps.check-releases.outputs.subspace_release_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.prepare-release.outputs.subspace_version }}_subspace
          name: gtladditions-subspace v${{ steps.prepare-release.outputs.subspace_version }}
          body: Auto-release triggered by version update.
          files: gtladditions-subspace/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
